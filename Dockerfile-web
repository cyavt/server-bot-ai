FROM node:18 AS web-builder
WORKDIR /app
# Copy package files first để tận dụng Docker cache
COPY main/manager-web/package*.json ./
# Install dependencies với retry và timeout
RUN npm install --prefer-offline --no-audit || \
    (sleep 5 && npm install --prefer-offline --no-audit) || \
    (sleep 10 && npm install --prefer-offline --no-audit)
# Copy source code sau khi đã install dependencies
COPY main/manager-web .
# Build với retry
RUN npm run build || (sleep 5 && npm run build)

FROM maven:3.9.4-eclipse-temurin-21 AS api-builder
WORKDIR /app
# Copy pom.xml trước để tận dụng Docker cache
COPY main/manager-api/pom.xml .
# Download dependencies (có thể cache được)
RUN mvn dependency:go-offline -Dmaven.test.skip=true || true
# Copy source code
COPY main/manager-api/src ./src
# Build với retry và timeout
RUN mvn clean package -Dmaven.test.skip=true -Dmaven.wagon.http.retryHandler.count=3 || \
    (sleep 10 && mvn clean package -Dmaven.test.skip=true -Dmaven.wagon.http.retryHandler.count=3)

FROM bellsoft/liberica-runtime-container:jre-21-glibc

RUN apk update && \
    apk add --no-cache --no-scripts \
        nginx \
        bash \
        fontconfig \
        ttf-dejavu \
    && rm -rf /var/cache/apk/* \
    && mkdir -p /run/nginx /var/log/nginx /var/tmp/nginx /etc/nginx/conf.d

COPY main/manager-web/public/generator/static/fonts/*.ttf /usr/share/fonts/

RUN fc-cache -f -v

COPY docs/docker/nginx.conf /etc/nginx/nginx.conf

COPY --from=web-builder /app/dist /usr/share/nginx/html

COPY --from=api-builder /app/target/xiaozhi-esp32-api.jar /app/xiaozhi-esp32-api.jar

EXPOSE 8002

# Tạo file start.sh
RUN printf '#!/bin/bash\n# Khởi động Java backend (lắng nghe cổng 8003 trong docker)\njava -jar /app/xiaozhi-esp32-api.jar \\\n  --server.port=8003 \\\n  --spring.datasource.druid.url=${SPRING_DATASOURCE_DRUID_URL} \\\n  --spring.datasource.druid.username=${SPRING_DATASOURCE_DRUID_USERNAME} \\\n  --spring.datasource.druid.password=${SPRING_DATASOURCE_DRUID_PASSWORD} \\\n  --spring.data.redis.host=${SPRING_DATA_REDIS_HOST} \\\n  --spring.data.redis.password=${SPRING_DATA_REDIS_PASSWORD} \\\n  --spring.data.redis.port=${SPRING_DATA_REDIS_PORT} &\n\n# Khởi động Nginx (chạy foreground để giữ container sống)\nnginx -g '"'"'daemon off;'"'"'\n' > /start.sh && \
    chmod +x /start.sh

CMD ["/start.sh"]