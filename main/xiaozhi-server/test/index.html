<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WINDIFY BOT</title>
    <link rel="stylesheet" href="css/test_page.css?v=0205">
    <script>
        // Phát hiện xem có đang sử dụng giao thức file:// để mở không
        if (window.location.protocol === 'file:') {
            document.addEventListener('DOMContentLoaded', function () {
                // Tạo lớp phủ mờ nền
                const overlayDiv = document.createElement('div');
                overlayDiv.className = 'file-protocol-overlay';
                document.body.appendChild(overlayDiv);

                // Tạo hộp cảnh báo
                const warningDiv = document.createElement('div');
                warningDiv.id = 'fileProtocolWarning';
                warningDiv.innerHTML = `
                    <h2>⚠️ Cảnh báo: Vui lòng sử dụng máy chủ HTTP để mở trang này</h2>
                    <p>Bạn hiện đang mở trang bằng cách sử dụng tệp cục bộ (giao thức file://), điều này có thể khiến trang hoạt động không bình thường.</p>
                    <p>Bạn có thể sử dụng nginx để ánh xạ và khởi động trang kiểm tra, hoặc làm theo các bước sau để sử dụng python khởi động dịch vụ http kiểm tra:</p>
                    <ol>
                        <li>Mở terminal dòng lệnh</li>
                        <li>Điều hướng đến thư mục xiaozhi-server/test</li>
                        <li>Thực thi lệnh sau để khởi động máy chủ HTTP:</li>
                    </ol>
                    <pre>python -m http.server 8006</pre>
                    <p>Sau đó truy cập trong trình duyệt: <strong>http://localhost:8006/test_page.html</strong></p>
                `;
                document.body.appendChild(warningDiv);
            });
        }
    </script>
</head>

<body>
    <!-- Container nền -->
    <div class="background-container" id="backgroundContainer">
        <div class="background-overlay"></div>
    </div>

    <!-- Container chính -->
    <div class="container">
        <!-- Vùng hiển thị camera (có thể kéo thả) -->
        <div class="camera-container" id="cameraContainer">
            <video id="cameraVideo" autoplay playsinline muted></video>
        </div>

        <!-- Chỉ báo trạng thái kết nối - Giữa đầu trang -->
        <div class="connection-status-top">
            <div class="status-indicator">
                <span class="status-dot status-disconnected"></span>
                <span id="connectionStatus">Ngoại tuyến</span>
            </div>
        </div>

        <!-- Thông báo tải mô hình -->
        <div class="model-container">
            <div class="model-loading" id="modelLoading">
                <div class="loading-char-float">
                    <div class="main-char">
                        <span>Đ</span><span>a</span><span>n</span><span>g</span><span> </span><span>t</span><span>ả</span><span>i</span><span> </span><span>m</span><span>ô</span><span> </span><span>h</span><span>ì</span><span>n</span><span>h</span><span>✨</span>
                    </div>
                    <div class="shadow-char">Đang tải mô hình✨</div>
                </div>
            </div>
        </div>

        <!-- Container Canvas Live2D -->
        <canvas id="live2d-stage"></canvas>

        <!-- Luồng tin nhắn chat (kiểu đạn màn hình) -->
        <div class="chat-container">
            <div class="chat-stream" id="chatStream">
                <!-- Tin nhắn chat sẽ được chèn động vào đây -->
            </div>
            <div class="chat-ipt" id="chatIpt">
                <input type="text" id="messageInput" autocomplete="off" placeholder="Nhập tin nhắn, nhấn Enter để gửi">
            </div>
        </div>

        <!-- Thanh điều khiển phía dưới -->
        <div class="control-bar">
            <button class="control-btn" id="settingsBtn" title="Cài đặt">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5A3.5 3.5 0 0 1 15.5 12A3.5 3.5 0 0 1 12 15.5M19.43 12.97C19.47 12.65 19.5 12.33 19.5 12C19.5 11.67 19.47 11.34 19.43 11L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.96 19.05 5.05L16.56 6.05C16.04 5.66 15.5 5.32 14.87 5.07L14.5 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.5 2.42L9.13 5.07C8.5 5.32 7.96 5.66 7.44 6.05L4.95 5.05C4.73 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.22 8.95 2.27 9.22 2.46 9.37L4.57 11C4.53 11.34 4.5 11.67 4.5 12C4.5 12.33 4.53 12.65 4.57 12.97L2.46 14.63C2.27 14.78 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.03 4.95 18.95L7.44 17.94C7.96 18.34 8.5 18.68 9.13 18.93L9.5 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.5 21.58L14.87 18.93C15.5 18.68 16.04 18.34 16.56 17.94L19.05 18.95C19.27 19.03 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.97Z" />
                </svg>
                <span class="btn-text">Cài đặt</span>
            </button>

            <button class="control-btn" id="cameraBtn" title="Vui lòng kết nối máy chủ trước" disabled>
                <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z" />
                </svg>
                <span class="btn-text">Camera</span>
            </button>

            <button class="control-btn dial-btn" id="dialBtn" title="Quay số">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" />
                </svg>
                <span class="btn-text">Quay số</span>
            </button>

            <button class="control-btn" id="recordBtn" title="Bắt đầu ghi âm" disabled>
                <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" />
                </svg>
                <span class="btn-text">Ghi âm</span>
            </button>
        </div>
    </div>

    <!-- Cửa sổ cài đặt -->
    <div class="modal" id="settingsModal">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <h2>Cài đặt</h2>
                <button class="close-btn" id="closeSettingsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="tab-btn active" data-tab="device">Cấu hình thiết bị</button>
                    <button class="tab-btn" data-tab="mcp">Công cụ MCP</button>
                    <button class="tab-btn" data-tab="other">Giao diện người số</button>
                </div>

                <div class="tab-content active" id="deviceTab">
                    <!-- Bảng cấu hình thiết bị -->
                    <div class="config-panel">
                        <div class="control-panel">
                            <div class="config-row">
                                <div class="config-item">
                                    <label for="deviceMac">MAC thiết bị:</label>
                                    <input type="text" id="deviceMac" placeholder="device-id">
                                </div>
                            </div>
                            <div class="config-row">
                                <div class="config-item">
                                    <label for="clientId">ID khách hàng:</label>
                                    <input type="text" id="clientId" value="web_test_client" placeholder="client-id">
                                </div>
                                <div class="config-item">
                                    <label for="deviceName">Tên thiết bị:</label>
                                    <input type="text" id="deviceName" value="Thiết bị kiểm tra Web" maxlength="50"
                                        placeholder="deviceName">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bảng thông tin kết nối -->
                    <div class="connection-controls">
                        <div class="input-group">
                            <label for="otaUrl">Địa chỉ máy chủ OTA:</label>
                            <input type="text" id="otaUrl" value="http://127.0.0.1:8002/xiaozhi/ota/"
                                placeholder="Địa chỉ máy chủ OTA, ví dụ: http://127.0.0.1:8002/xiaozhi/ota/" />
                        </div>
                        <div class="input-group">
                            <label for="serverUrl">Địa chỉ máy chủ WebSocket:</label>
                            <input type="text" id="serverUrl" value="" readonly disabled
                                placeholder="Sau khi điền địa chỉ OTA, nhấn nút quay số để tự động kết nối" />
                        </div>
                        <div class="input-group">
                            <label for="visionUrl">Địa chỉ phân tích thị giác:</label>
                            <input type="text" id="visionUrl" value="" readonly disabled placeholder="Tự động lấy sau khi thiết lập kết nối ws thành công" />
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="mcpTab">
                    <!-- Vùng quản lý công cụ MCP -->
                    <div class="mcp-tools-container">
                        <div class="mcp-tools-header">
                            <h3>Quản lý công cụ MCP</h3>
                        </div>
                        <div class="mcp-tools-panel" id="mcpToolsPanel">
                            <div class="mcp-tools-list" id="mcpToolsContainer">
                                <!-- Danh sách công cụ sẽ được chèn động vào đây -->
                            </div>
                            <div class="mcp-actions">
                                <button class="btn-primary" id="addMcpToolBtn">
                                    ➕ Thêm công cụ mới
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="otherTab">
                    <div class="other-settings-panel">
                        <div class="control-panel">
                            <div class="config-row">
                                <div class="config-item">
                                    <label>Chọn mô hình:</label>
                                    <select id="live2dModelSelect" class="model-select">
                                        <option value="hiyori_pro_zh">hiyori (Xuân Nhật)</option>
                                        <option value="natori_pro_zh">natori (Danh Thủ)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="config-row">
                                <div class="config-item">
                                    <label></label>
                                    <button class="background-btn" id="backgroundBtn" title="Chuyển đổi nền">
                                        <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12,18A6,6 0 0,1 6,12C6,11 6.25,10.03 6.7,9.2L5.24,7.74C4.46,8.97 4,10.43 4,12A8,8 0 0,0 12,20V23L16,19L12,15V18M12,4V1L8,5L12,9V6A6,6 0 0,1 18,12C18,13 17.75,13.97 17.3,14.8L18.76,16.26C19.54,15.03 20,13.57 20,12A8,8 0 0,0 12,4Z" />
                                        </svg>
                                        <span class="btn-text">Chuyển đổi nền</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hộp thoại chỉnh sửa công cụ MCP -->
    <div id="mcpToolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="mcpModalTitle">Thêm công cụ</h2>
                <button class="close-btn" id="closeMcpModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="mcpErrorContainer"></div>
                <form id="mcpToolForm">
                    <div class="input-group">
                        <label for="mcpToolName">Tên công cụ *</label>
                        <input type="text" id="mcpToolName" placeholder="Ví dụ: self.get_device_status" required>
                    </div>
                    <div class="input-group">
                        <label for="mcpToolDescription">Mô tả công cụ *</label>
                        <textarea id="mcpToolDescription" placeholder="Mô tả chi tiết chức năng và tình huống sử dụng của công cụ..." required></textarea>
                    </div>
                    <div class="input-group">
                        <div class="input-group-header">
                            <label>Tham số đầu vào</label>
                            <button type="button" class="properties-btn-primary" id="addMcpPropertyBtn">
                                ➕ Thêm tham số
                            </button>
                        </div>
                        <div class="properties-container">
                            <div class="mcp-empty-state" id="mcpEmptyState">
                                Chưa có tham số, nhấn nút phía trên để thêm tham số
                            </div>
                            <div class="mcp-properties-list" id="mcpPropertiesContainer">
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="mcpMockResponse">
                            Kết quả trả về mô phỏng (Định dạng JSON, tùy chọn)
                            <span style="font-size: 12px; color: #999; font-weight: normal;">- Để trống sẽ trả về thông báo thành công mặc định</span>
                        </label>
                        <textarea id="mcpMockResponse" placeholder='{"success": true, "data": "Thực thi thành công"}'></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" id="cancelMcpBtn">Hủy</button>
                        <button type="submit" class="btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Hộp thoại chỉnh sửa tham số -->
    <div id="mcpPropertyModal" class="modal">
        <div class="modal-content property-modal">
            <div class="modal-header">
                <h2 id="mcpPropertyModalTitle">Chỉnh sửa tham số</h2>
                <button class="close-btn" id="closeMcpPropertyModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="mcpPropertyForm">
                    <input type="hidden" id="mcpPropertyIndex" value="-1">
                    <div class="input-group">
                        <label for="mcpPropertyName">Tên tham số *</label>
                        <input type="text" id="mcpPropertyName" placeholder="Ví dụ: param_1" required>
                    </div>
                    <div class="input-group">
                        <label for="mcpPropertyType">Kiểu dữ liệu *</label>
                        <select id="mcpPropertyType" class="model-select" required>
                            <option value="string">Chuỗi</option>
                            <option value="integer">Số nguyên</option>
                            <option value="number">Số</option>
                            <option value="boolean">Boolean</option>
                            <option value="array">Mảng</option>
                            <option value="object">Đối tượng</option>
                        </select>
                    </div>
                    <div class="input-group" id="mcpPropertyRangeGroup" style="display: none;">
                        <div class="config-row">
                            <div class="config-item">
                                <label for="mcpPropertyMinimum">Giá trị tối thiểu</label>
                                <input type="number" id="mcpPropertyMinimum" placeholder="Tùy chọn">
                            </div>
                            <div class="config-item">
                                <label for="mcpPropertyMaximum">Giá trị tối đa</label>
                                <input type="number" id="mcpPropertyMaximum" placeholder="Tùy chọn">
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="mcpPropertyDescription">Mô tả tham số</label>
                        <input type="text" id="mcpPropertyDescription" placeholder="Tùy chọn">
                    </div>
                    <div class="input-group">
                        <label class="mcp-checkbox-label">
                            <input type="checkbox" id="mcpPropertyRequired">
                            Tham số bắt buộc
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-secondary" id="cancelMcpPropertyBtn">Hủy</button>
                        <button type="submit" class="btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tải nền -->
    <script src="js/ui/background-load.js?v=0205"></script>

    <!-- Engine render 2D PIXI.js -->
    <script src="js/live2d/pixi.js?v=0205"></script>

    <!-- Live2D Cubism 4.0 SDK -->
    <script src="js/live2d/live2dcubismcore.min.js?v=0205"></script>
    <script src="js/live2d/cubism4.min.js?v=0205"></script>

    <!-- Quản lý Live2D -->
    <script src="js/live2d/live2d.js?v=0205"></script>

    <!-- Thư viện giải mã Opus -->
    <script src="js/utils/libopus.js?v=0205"></script>

    <!-- Điểm vào ứng dụng chính -->
    <script type="module" src="js/app.js?v=0205"></script>

    <!-- Xử lý lỗi toàn cục -->
    <script>
        // Thêm xử lý lỗi toàn cục
        window.addEventListener('error', function (event) {
            console.error('Lỗi toàn cục:', event.error);
        });

        // Thêm xử lý Promise bị từ chối chưa được xử lý
        window.addEventListener('unhandledrejection', function (event) {
            console.error('Promise bị từ chối chưa được xử lý:', event.reason);
        });
    </script>
</body>

</html>